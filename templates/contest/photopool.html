{% extends 'base.html' %}
{% load static %}
{% load ratings %}
{% load checkandincrease %}


{% block title %}Photo pool{% endblock %}


{% block body %}




<section>

  <div class="inner-more">

      <div class="container">
        <div class="photopool-main-wrapper">
            <div class="photopool-slider-wrapper">
                <div class="photopool-slider-control" id="photopool-control-1"></div>
                <div class="owl-carousel photopool-slider">
            </div>
           </div>
        </div>
      </div>
  </div>

</section>

<script>
    $(document).ready(function(){
       getPhotos(null);

       var owl = $('.owl-carousel').owlCarousel();
            owl.on('changed.owl.carousel', function(event){
                var itemIndex = event.item.index + 1;
                if(photoCount === 10){
                    itemIndex += 3;
                }else{
                    lastItemIndex = totalPhotoCount - 3;
                }
                if(itemIndex === (lastItemIndex)){
                    getPhotos(next);

                }
            });
        });

    function report(photoId, event){
        var url = "http://127.0.0.1:8000/api/report-photo/" + photoId;
        event.preventDefault();
        $.ajax({
            url: url,
            type: "GET",
            success: function(result){
                alert('Successfuly reported this photo.');
            },
            error: function(result){
                alert('error' + result);
            }
        })
    }
        var lastItemIndex = 0; //THESE ARE IMPORTANT PLEASE DO NOT CHANGE
        var photoCount = 0; //THESE ARE IMPORTANT PLEASE DO NOT CHANGE
        var next = ""; //THESE ARE IMPORTANT PLEASE DO NOT CHANGE
        var totalPhotoCount = 0; //THESE ARE IMPORTANT PLEASE DO NOT CHANGE
        var photosSeen = []; //THESE ARE IMPORTANT PLEASE DO NOT CHANGE

        function writeResults(result, owl){
            var tagAsStr = '';
            var tag = result['results'][0]['contest']['tag'];
            $.each(tag, function(index, value){
                tagAsStr += "#" + value['title'];
                index++;
                console.log(index);
                console.log(tag.length);
                if(index !== tag.length){
                    tagAsStr += " | ";
                }

            });


            $.each(result['results'], function(index, value){
                console.log(value);
                if(!photosSeen.includes(value['id'])){
                    owl.trigger('add.owl.carousel', [jQuery("<div class=\"photopool-img-wrapper\" id='" + value["id"] + "'>\n" +
                   "           <a href='" + value['photoItself'] + "' data-fancybox data-caption=\"My caption\">\n" +
                   "            <img class=\"\" src='" + value['photoItself'] + "'>\n" +
                   "           </a></div>\n" +
                   "            <div class=\"photopool-content\">\n" +
                   "                <div class=\"photopool-item-title-wrap\">\n" +
                   "                    <h4 class=\"photo-title\">" + value['contest']['tag'] + "</h4>\n"+
                   "                </div>\n" +
                   "                <div class=\"photopool-item-description-wrap\"><p>Fotografin Aciklamasai ve Bilgileri</p></div>\n" +
                   "                <div class=\"photopool-item-contest-title\">\n"+
                   "                    <h4>Human In The Nature Competetion</h4>\n"+
                   "                </div>\n"+
                   "                <div class=\"photopool-item-date-wrapper\">\n"+
                   "                    <p>Last Update Date: <span>04/03/2018</span></p>\n" +
                   "                </div>\n"+
                   "                <div class=\"photopool-item-comments\">\n"+
                   "                    <p>Yansma Bilgeri ve Kurallan</p>\n" +
                   "                    <p>Yansma Bilgeri ve Kurallan</p>\n" +
                   "                    <p>Yansma Bilgeri ve Kurallan</p>\n" +
                   "                    <p>Yansma Bilgeri ve Kurallan</p>\n" +
                   "                </div>\n"+
                   "                <div class=\"photopool-item-btn-wrap\">\n" +
                   "                    <button class=\"btn btn-fill\">Vote</button>\n"+
                   "                </div>\n" +
                   "                <div class=\"photopool-item-tags-wrap\">\n"+
                   "                    <div class=\"tags-wrap\">\n"+ tagAsStr + "\n"+
                   "                    </div>\n" +
                   "                    <button class=\"btn-txt-only\">&hellip;</button> \n" +
                   "                    <form class=\"form-report\" onclick=\"report('"+ value['id'] + "', event)\">\n" +
                   "                        <input class=\"btn-report\" type=\"submit\" value=\"Report\" >\n" +
                   "                    </form>\n" +
                   "                </div>\n" +
                   "            </div>\n" +
                   "       </div>")]);
                            $(document).ready(function(){
                              var val = 1;
                              $(".photopool-slider-wrapper .photopool-content .photopool-item-tags-wrap>.btn-txt-only").click(function(){
                                  if (val== 1) {
                                      $(this).siblings('.form-report').show();
                                      val = 0;
                                      console.log("Sucess 1");
                                  }
                                  else {
                                      val = 1;
                                      $(this).siblings('.form-report').hide();
                                      console.log("Sucess 1");
                                  }
                                  return false;
                              });
                           });
                        }else{
                            console.log('Photo has been seen already.');
                        }
                  photosSeen.push(value['id']);
            });
        }
        /*$(document).ready(function(){

            $('.photopool-slider-control>.owl-next').click(function(){
               if($('.photopool-slider-wrapper .owl-item.active').is(':nth-last-child(3)')) {
                  alert('Third Last Child Coming in the View !');
                }
            });
        });*/

        function getPhotos(Url){
            var url = "";
            //alert("get this: " + Url);
            if(Url === null){
                url = '{% url "photo_api:index_api" slug=contest.slug %}';
            }else{
                url = Url;
            }
            $.ajax({
                url: url,
                type: "GET",
                success: function(result){
                    var count = result["count"];
                    next = result["next"];
                    var pre = result["previous"];
                    lastItemIndex += result['results'].length;
                    photoCount = result['results'].length;
                    totalPhotoCount = result['count'];
                    var owl = $('.owl-carousel').owlCarousel({items:2, nav:true, loop: false, lazyLoad: true});
                    writeResults(result, owl);
                    owl.trigger('refresh.owl.carousel', {nav: false, loop:true});
                },
                error: function(result){
                    console.log(result);
                }
            });
        }

</script>

{% endblock %}